{% load static %}
<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Supervisor Scheduler</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; padding: 20px; background: #f4f4f9; }
    .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .top-bar { display: flex; gap: 20px; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 20px; align-items: flex-end;}
    .panel { flex: 1; }
    label { display: block; font-weight: 600; margin-bottom: 5px; font-size: 14px; }
    select { padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 100%; box-sizing: border-box;}
    button { cursor: pointer; background: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 4px; font-weight: 600; }
    button:hover { background: #0056b3; }
    button.secondary { background: #6c757d; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    .grid-container { overflow-x: auto; margin-top: 20px; }
    .grid { display: grid; grid-template-columns: 80px repeat(7, 1fr); gap: 1px; background: #ddd; border: 1px solid #ccc; width: 100%; min-width: 800px; }
    .cell { background: white; height: 25px; font-size: 10px; display:flex; align-items: center; justify-content: center; user-select: none; }
    .header { font-weight: 700; text-align: center; padding: 8px 0; background: #f8f9fa; color: #333; }
    .time-label { background: #f8f9fa; font-size: 11px; padding-right: 8px; justify-content: flex-end; display: flex; align-items: center; color: #666; }
    .cell.unavailable { background-color: #ffcccc; cursor: not-allowed; background-image: repeating-linear-gradient(45deg, #ffb3b3 0, #ffb3b3 1px, transparent 0, transparent 50%); background-size: 10px 10px; }
    .cell.scheduled { background-color: #28a745; color: white; }
    .legend { display: flex; gap: 20px; margin-bottom: 10px; font-size: 12px; }
    .dot { width: 12px; height: 12px; display: inline-block; margin-right: 5px; border: 1px solid #ccc; }
  </style>
</head>
<body>

{% csrf_token %}

<div class="container">
  <h2>Supervisor Dashboard</h2>

  <div class="top-bar">
    <div class="panel">
      <label>1. Select Worker</label>
      
      <select id="workerSelect" onchange="loadWorkerData()">
        <option value="" disabled selected>-- Choose a Worker --</option>
        {% for worker in workers %}
            <option value="{{ worker.id }}">
                {{ worker.first_name|default:worker.username }} {{ worker.last_name }}
            </option>
        {% empty %}
            <option disabled>No workers found in DB</option>
        {% endfor %}
      </select>
      
    </div>

    <div class="panel">
      <label>Assign Role</label>
      <select id="workerRole">
        <option value="Tutor">General Tutor</option>
        <option value="SI_Leader">SI Leader</option>
        <option value="Lab_Assistant">Lab Assistant</option>
        <option value="Floater">Floater</option>
      </select>
    </div>

    <div class="panel" style="flex: 0 0 auto;">
        <button class="secondary" onclick="clearGrid()">Clear Grid</button>
    </div>
  </div>

  <div class="legend">
    <span><span class="dot" style="background:white"></span>Available</span>
    <span><span class="dot" style="background:#ffcccc"></span>Unavailable</span>
    <span><span class="dot" style="background:#28a745"></span>Shift Assigned</span>
  </div>

  <div class="grid-container">
    <div id="grid" class="grid"></div>
  </div>

  <div style="margin-top: 20px; text-align: right;">
    <button id="saveBtn" onclick="saveSchedule()" style="background: #17a2b8;" disabled>Save Schedule</button>
  </div>
</div>

<script>
  const days = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
  const keyToIndex = { "sun":0, "mon":1, "tues":2, "wed":3, "thur":4, "fri":5, "sat":6 };
  const indexToKey = ["sun", "mon", "tues", "wed", "thur", "fri", "sat"];
  const startHour = 8;
  const endHour = 22; 
  const stepMinutes = 15;
  const gridEl = document.getElementById("grid");
  const cells = []; 

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
  }

  function initGrid() {
    gridEl.innerHTML = "";
    cells.length = 0;
    div("header", "");
    days.forEach(d => div("header", d));

    for (let t = startHour * 60; t < endHour * 60; t += stepMinutes) {
      const label = (t % 60 === 0) ? `${Math.floor(t/60)}:00` : "";
      div("time-label", label);
      for (let d = 0; d < 7; d++) {
        const cell = document.createElement("div");
        cell.className = "cell";
        cell.dataset.day = d;
        cell.dataset.minutes = t;
        cell.addEventListener("mousedown", handleCellClick);
        cell.addEventListener("mouseover", handleCellHover);
        gridEl.appendChild(cell);
        cells.push(cell);
      }
    }
  }

  function div(cls, txt) {
    const el = document.createElement("div");
    el.className = cls;
    el.textContent = txt;
    gridEl.appendChild(el);
  }

  function loadWorkerData() {
    clearGrid(); 
    const workerId = document.getElementById("workerSelect").value;
    if (!workerId) return;

    fetch(`/api/get-availability/${workerId}/`)
    .then(response => response.json())
    .then(data => {
      if(data.error) { alert(data.error); return; }

      for (const [dayKey, ranges] of Object.entries(data.unavailable)) {
        const dayIndex = keyToIndex[dayKey.toLowerCase()];
        if (dayIndex === undefined) continue;

        ranges.forEach(range => {
          const startMins = timeStrToMinutes(range[0]);
          const endMins = timeStrToMinutes(range[1]);
          cells.forEach(cell => {
            const cellDay = parseInt(cell.dataset.day);
            const cellTime = parseInt(cell.dataset.minutes);
            if (cellDay === dayIndex && cellTime >= startMins && cellTime < endMins) {
              cell.classList.add("unavailable");
            }
          });
        });
      }
      document.getElementById("saveBtn").disabled = false;
    })
    .catch(err => { console.error(err); alert("Error loading worker."); });
  }

  let isMouseDown = false;
  let toggleMode = "add"; 
  function handleCellClick(e) {
    if (e.buttons !== 1) return; 
    const cell = e.target;
    if (cell.classList.contains("unavailable")) return;
    isMouseDown = true;
    toggleMode = cell.classList.contains("scheduled") ? "remove" : "add";
    applySchedule(cell);
  }
  function handleCellHover(e) { if (isMouseDown) applySchedule(e.target); }
  function applySchedule(cell) {
    if (cell.classList.contains("unavailable")) return;
    if (toggleMode === "add") cell.classList.add("scheduled");
    else cell.classList.remove("scheduled");
  }
  window.addEventListener("mouseup", () => isMouseDown = false);

  function saveSchedule() {
    const workerId = document.getElementById("workerSelect").value;
    const role = document.getElementById("workerRole").value;
    if (!workerId) return alert("No worker selected.");

    const assignedShifts = {}; 
    const rawTimes = {}; 
    cells.forEach(cell => {
      if (cell.classList.contains("scheduled")) {
        const d = parseInt(cell.dataset.day);
        const t = parseInt(cell.dataset.minutes);
        if (!rawTimes[d]) rawTimes[d] = [];
        rawTimes[d].push(t);
      }
    });

    Object.keys(rawTimes).forEach(d => {
      const times = rawTimes[d].sort((a,b) => a-b);
      const dayKey = indexToKey[d];
      assignedShifts[dayKey] = [];
      let start = times[0];
      let prev = times[0];
      for (let i = 1; i <= times.length; i++) {
        const current = times[i];
        if (current !== prev + stepMinutes) {
          assignedShifts[dayKey].push([minutesToTimeStr(start), minutesToTimeStr(prev + stepMinutes)]);
          start = current;
        }
        prev = current;
      }
    });

    fetch('/api/save-schedule/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
        body: JSON.stringify({ worker_id: workerId, role: role, assigned_shifts: assignedShifts })
    })
    .then(res => res.json())
    .then(data => {
        if(data.status === 'success') alert("Schedule saved!");
        else alert("Error: " + data.message);
    });
  }

  function clearGrid() { cells.forEach(c => c.className = "cell"); document.getElementById("saveBtn").disabled = true; }
  function timeStrToMinutes(str) { const [h, m] = str.split(":").map(Number); return h * 60 + m; }
  function minutesToTimeStr(mins) { const h = Math.floor(mins / 60); const m = mins % 60; return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`; }

  initGrid();
</script>
</body>
</html>