{% extends 'core/base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/availability.css' %}">
<style>
    /* Modal fallback styling */
    #eventModal.show {
        display: block !important;
        z-index: 1050;
    }
    
    #eventModal.show::before {
        content: '';
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1040;
    }
    
    #eventModal .modal-dialog {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 1051;
    }

    /* Modal content styling */
    #eventModal .modal-content {
        border: 3px solid #0066cc !important;
        background-color: #ffffff !important;
    }

    /* Input fields styling */
    #modalEventName,
    #modalLocation {
        border: 2px solid #000 !important;
        background-color: #ffffff !important;
    }

    #modalEventName:focus,
    #modalLocation:focus {
        border-color: #0066cc !important;
        box-shadow: 0 0 0 0.2rem rgba(0, 102, 204, 0.25);
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Submit Your Availability: {{ team.name }}</h2>
        <button class="btn btn-success px-4" onclick="saveAllPreferences()">Save Changes</button>
    </div>

    <div class="card mb-4 border-0 shadow-sm">
        <div class="card-body bg-light rounded d-flex flex-wrap gap-4 align-items-end">
            <div style="min-width: 200px;">
                <label class="form-label fw-bold small text-uppercase">1. Choose Role</label>
                <select id="prefRole" class="form-select">
                    {% for role in team.roles.all %}
                        <option value="{{ role.id }}" data-color="{{ role.color }}">{{ role.name }}</option>
                    {% empty %}
                        <option disabled>No roles created by supervisor</option>
                    {% endfor %}
                </select>
            </div>
            <div style="min-width: 250px;">
                <label class="form-label fw-bold small text-uppercase">2. Building / Room</label>
                <input type="text" id="prefBuilding" class="form-control" placeholder="e.g. Science Hall 202">
            </div>
            <div class="flex-grow-1 text-muted small pb-2">
                <i class="bi bi-info-lg text-primary"></i> 
                <strong>How to use:</strong> Click and drag vertically on the grid to mark when and where you prefer to work.
            </div>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="sidebar">
           <h3>Preferred Roles</h3>
            {% for role in roles %}
            <label>
                <input type="checkbox" class="role-checkbox" value="{{ role.id }}"
                    {% if role.id in selected_role_ids %}checked{% endif %}>
                {{ role.name }}
            </label><br>
            {% endfor %}
            <select id="prefBuilding">
                <option value="Main Library">Main Library</option>
                <option value="Science Center">Science Center</option>
                <option value="Student Union">Student Union</option>
            </select>

            <hr>
            
            <button id="saveAllBtn" class="btn-save">Save All Preferences</button>
        </div>

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>Weekly Availability: {{ team.name }}</h2>
        <div class="d-flex gap-2">
            <button class="btn btn-outline-danger" onclick="clearGrid()">Clear All</button>
            <button class="btn btn-success px-4" onclick="saveAllPreferences()">Save Schedule</button>
        </div>
        <div class="card-header bg-white border-0 py-2" 
            style="display: grid; grid-template-columns: 60px repeat(7, 1fr); text-align: center; font-weight: bold; color: #666; font-size: 0.85rem;">
            <div></div> <div>SUN</div>
            <div>MON</div>
            <div>TUE</div>
            <div>WED</div>
            <div>THU</div>
            <div>FRI</div>
            <div>SAT</div>
        </div>
    </div>

        <div class="grid-wrapper" id="gridWrapper">
            <div id="gridBackground" class="grid-bg-container"></div>
            <div id="blocks-layer"></div>
            <div id="drawingOverlay" class="drawing-overlay d-none"></div>
        </div>
    </div>

<!-- Event Details Modal -->
<div id="eventModal" class="modal fade" tabindex="-1" style="display: none;">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header border-bottom-0 pt-4">
                <h5 class="modal-title fw-bold">Add Event</h5>
                <button type="button" class="btn-close" onclick="closeEventModal()"></button>
            </div>
            <div class="modal-body px-4 py-3">
                <!-- Time Range Display -->
                <div class="alert alert-light border rounded mb-4 p-3" style="background-color: #f8f9fa;">
                    <small class="text-muted">Scheduled Time</small>
                    <div class="fw-bold text-dark" id="timeRangeDisplay">8:00 AM - 9:00 AM</div>
                </div>

                <!-- Event Name Input -->
                <div class="mb-4">
                    <label class="form-label fw-bold mb-2">Event Name</label>
                    <input type="text" id="modalEventName" class="form-control form-control-lg border-2" 
                        placeholder="e.g. Library Shift, Tutoring Session" style="border-color: #e0e0e0;">
                </div>

                <!-- Location Input -->
                <div class="mb-4">
                    <label class="form-label fw-bold mb-2">Location</label>
                    <input type="text" id="modalLocation" class="form-control form-control-lg border-2" 
                        placeholder="e.g. Science Hall 202" style="border-color: #e0e0e0;">
                </div>
            </div>
            <div class="modal-footer border-top-0 pb-4">
                <button type="button" class="btn btn-light border me-2" onclick="closeEventModal()">Cancel</button>
                <button type="button" class="btn btn-primary px-4" onclick="confirmEventDetails()">Add to Schedule</button>
            </div>
        </div>
    </div>
</div>

{{ existing_availabilities_json|json_script:"availability-data" }}

<script>
    // 2. Simple Configuration
    window.TEAM_ID = "{{ team.id }}";
    window.START_HOUR = 8;
    window.END_HOUR = 22;
    window.SLOT_HEIGHT = 25;

    // 3. The Data Bridge (No loops, no syntax errors)
    const dataElement = document.getElementById('availability-data');
    window.SAVED_AVAILABILITY = JSON.parse(dataElement.textContent);
</script>

<script src="{% static 'js/availability.js' %}"></script>
{% endblock %}